<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Dima AI</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* [YOUR AMAZING CSS - NO CHANGES NEEDED] */
        :root {
            /* Cosmic Color Palette (from your existing styles) */
            --gradient-start: #1A2980; /* Deep Indigo */
            --gradient-end: #26D0CE;   /* Vibrant Teal */
            --gradient-start-rgb: 26, 41, 128;
            --gradient-end-rgb: 38, 208, 206;

            --color-nebula-deep: #080A10; 
            --color-nebula-mid: #10182B;  
            --color-nebula-highlight: #3D52A0; 
            --color-star: #FFFFFF;
            
            --color-primary-dark: var(--gradient-start);
            --color-primary-light: var(--gradient-end);

            --color-background-dark: var(--color-nebula-deep);
            --color-background-medium-dark: #101419; /* Slightly lighter for app bg */
            --color-background-panel: #151E33; /* For cards and panels in dashboard */
            --color-background-panel-hover: #1B263E;
            --color-background-light: #FFFFFF;
            --color-background-offwhite: #F9FAFB; 

            --color-text-light: #EAEFF3;
            --color-text-primary-on-dark: #FFFFFF;
            --color-text-dark: #1A202C;
            --color-text-medium: #A0AEC0; /* Lighter medium for dark bg */
            --color-text-muted: #718096;
            --color-accent: #FBBF24; 
            --color-focus-ring: #4DA8DA;

            --color-success: #38A169;
            --color-warning: #DD6B20;
            --color-danger: #E53E3E;

            --font-primary: 'Manrope', 'Cairo', sans-serif;
            --font-secondary: 'Inter', 'Cairo', sans-serif;

            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px; 
            --shadow-subtle: 0 2px 8px rgba(0,0,0,0.07);
            --shadow-medium: 0 6px 15px rgba(0,0,0,0.1);
            --shadow-strong: 0 10px 30px rgba(0,0,0,0.12), 0 2px 10px rgba(0,0,0,0.08);
            --shadow-app-panel: 0 8px 25px rgba(0,0,0,0.2), 0 0 0 1px rgba(var(--color-nebula-highlight-rgb, 61, 82, 160), 0.2);

            --sidebar-width: 260px;
            --header-height: 70px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Inter:wght@400;500;600&family=Cairo:wght@400;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-secondary);
            color: var(--color-text-light); /* Default text color for app */
            line-height: 1.6;
            background-color: var(--color-background-medium-dark); 
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html { scroll-behavior: smooth; }

        /* ... [All your other beautiful CSS styles] ... */

        /* Styles for the Connect Pages Modal */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--color-background-panel);
            padding: 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-strong);
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(var(--color-nebula-highlight-rgb,61,82,160),0.3);
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 15px; left: 15px; /* RTL support */
            background: none; border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
        }
        .modal-content h3 { color: var(--color-text-light); }
        .modal-content p { color: var(--color-text-medium); }
        #modalPageList { list-style: none; margin-top: 20px; max-height: 40vh; overflow-y: auto; padding: 0; }
        #modalPageList li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: var(--color-background-medium-dark);
            border-radius: var(--border-radius-md); margin-bottom: 10px;
        }
        .page-name { font-weight: 600; }
        .page-username { font-size: 0.9rem; color: var(--color-text-muted); }
        .modal-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--gradient-end);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Existing CSS ... */
        .app-layout { display: flex; min-height: 100vh; }
        /* ... All your other CSS from the original file ... */
        .account-card .btn-app[disabled] { cursor: not-allowed; filter: grayscale(50%); }
    </style>
</head>
<body>
    <!-- MODAL HTML (hidden by default) -->
    <div class="modal-backdrop" id="pagesModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="modalCloseBtn">×</button>
            <h3>اختر صفحة الإنستغرام للربط</h3>
            <p>اختر صفحة الأعمال التي تريد ربطها بـ Dima AI.</p>
            <div class="modal-loader" id="modalLoader"></div>
            <ul id="modalPageList"></ul>
            <p id="modalStatus" style="text-align:center; margin-top: 15px;"></p>
        </div>
    </div>
    
    <!-- YOUR DASHBOARD HTML -->
    <div class="app-layout">
        <div class="main-content-wrapper" style="width: 100%; padding: 0;"> <!-- Simplified for focus -->
             <main class="page-content">
                <!-- Connect Accounts -->
                <section class="dashboard-section connect-accounts-section" style="max-width: 500px; margin: 40px auto;">
                    <div class="section-header">
                        <h2>ربط قنواتك الكونية</h2>
                    </div>
                    <div class="account-connection-list">
                        <div class="account-card" id="instagramAccountCard">
                            <i class="fab fa-instagram account-icon" style="color: #E1306C;"></i>
                            <div class="account-info">
                                <h4>إنستغرام</h4>
                                <p id="instagramStatus" class="status-disconnected">غير متصل</p>
                            </div>
                            <button class="btn-app btn-app-outline" id="connectInstagramBtn">ربط الحساب</button>
                        </div>
                    </div>
                </section>
             </main>
        </div>
    </div>

    <!-- JAVASCRIPT SECTION -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =========================================================================
            // FACEBOOK/INSTAGRAM CONNECTION LOGIC
            // =========================================================================
            const YOUR_APP_ID = '1323436732086944'; 
            const connectBtn = document.getElementById('connectInstagramBtn');
            const instagramStatus = document.getElementById('instagramStatus');
            const modal = document.getElementById('pagesModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalLoader = document.getElementById('modalLoader');
            const modalPageList = document.getElementById('modalPageList');
            const modalStatus = document.getElementById('modalStatus');

            // --- Load Facebook SDK ---
            window.fbAsyncInit = function() {
                FB.init({
                    appId: YOUR_APP_ID,
                    cookie: true,
                    xfbml: true,
                    version: 'v19.0'
                });
                // NEW: Added this line from the official documentation
                FB.AppEvents.logPageView();   
            };

            (function(d, s, id){
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
            
            // --- Event Listener ---
            if(connectBtn) {
                connectBtn.addEventListener('click', handleConnectClick);
            }
            if(modalCloseBtn) {
                modalCloseBtn.addEventListener('click', () => modal.style.display = 'none');
            }

            function handleConnectClick() {
                connectBtn.textContent = 'جاري الاتصال...';
                connectBtn.disabled = true;

                const requiredPermissions = 'pages_show_list,instagram_basic,instagram_manage_messages,pages_read_engagement';
                
                FB.login(function(response) {
                    if (response.authResponse) {
                        openPagesModal();
                        fetchInstagramPages(response.authResponse.accessToken);
                    } else {
                        alert('فشل تسجيل الدخول. يرجى السماح بالأذونات المطلوبة.');
                        resetConnectButton();
                    }
                }, { scope: requiredPermissions, config_id: 'YOUR_CONFIG_ID' }); // config_id might be needed
            }
            
            function openPagesModal() {
                modal.style.display = 'flex';
                modalLoader.style.display = 'block';
                modalPageList.innerHTML = '';
                modalStatus.textContent = '';
                resetConnectButton(); // Reset the main button while modal is open
            }

            function fetchInstagramPages(userAccessToken) {
                FB.api('/me/accounts', { 
                    fields: 'name,access_token,instagram_business_account{name,username}', 
                    access_token: userAccessToken 
                }, function(response) {
                    modalLoader.style.display = 'none';
                    if (response && !response.error) {
                        const igPages = response.data.filter(page => page.instagram_business_account);
                        if (igPages.length > 0) {
                            displayPagesInModal(igPages);
                        } else {
                            modalStatus.textContent = 'لم يتم العثور على حسابات إنستغرام للأعمال.';
                        }
                    } else {
                        modalStatus.textContent = 'خطأ في جلب الصفحات: ' + (response.error ? response.error.message : 'Unknown error');
                    }
                });
            }

            function displayPagesInModal(pages) {
                modalPageList.innerHTML = '';
                pages.forEach(page => {
                    const li = document.createElement('li');
                    li.innerHTML = `<div><strong class="page-name">${page.name}</strong><br><span class="page-username">@${page.instagram_business_account.username}</span></div>`;
                    const selectBtn = document.createElement('button');
                    selectBtn.textContent = 'اختر';
                    selectBtn.className = 'btn-app btn-app-secondary';
                    selectBtn.onclick = () => {
                        modalStatus.textContent = `جاري ربط @${page.instagram_business_account.username}...`;
                        subscribePageToApp(page.id, page.access_token, page.instagram_business_account.username);
                    };
                    li.appendChild(selectBtn);
                    modalPageList.appendChild(li);
                });
            }

            function subscribePageToApp(pageId, pageAccessToken, igUsername) {
                FB.api(`/${pageId}/subscribed_apps`, 'post', {
                    subscribed_fields: ['messages'],
                    access_token: pageAccessToken
                }, function(response) {
                    if (response && response.success) {
                        modal.style.display = 'none';
                        updateDashboardToConnected(igUsername);
                        alert('تم ربط الصفحة بنجاح!');
                    } else {
                        modalStatus.innerHTML = 'خطأ: لم نتمكن من ربط الصفحة. ' + (response.error ? response.error.message : '');
                    }
                });
            }
            
            function updateDashboardToConnected(igUsername) {
                instagramStatus.textContent = `متصل: @${igUsername}`;
                instagramStatus.className = 'status-connected';
                connectBtn.textContent = 'إدارة';
                connectBtn.className = 'btn-app btn-app-manage';
                connectBtn.disabled = false;
                connectBtn.onclick = () => alert('إدارة إعدادات إنستغرام (قيد الإنشاء)!');
            }
            
            function resetConnectButton() {
                connectBtn.textContent = 'ربط الحساب';
                connectBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
